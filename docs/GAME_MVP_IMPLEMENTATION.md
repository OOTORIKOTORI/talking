# アドベンチャーゲーム製作機能 MVP 実装完了

## 実装内容

このMVPでは、Talkingプラットフォーム上にアドベンチャーゲーム（ビジュアルノベル）製作機能を追加しました。

### ✅ 完了した実装

#### 1. データベーススキーマ (Prisma)
- `GameProject`: ゲームプロジェクト本体
- `GameScene`: ゲーム内のシーン（章・場面）
- `GameNode`: 台詞や演出を持つノード（DIALOG型）
- `GameChoice`: 選択肢（ノードから別のノードへの分岐）

マイグレーション: `20251103001050_game_mvp`

#### 2. バックエンドAPI (NestJS)
**エンドポイント:**
- `GET /games/my` - 自分のゲームプロジェクト一覧
- `POST /games` - 新規ゲームプロジェクト作成
- `GET /games/:id` - ゲーム詳細取得（公開ゲームは認証不要）
- `PATCH /games/:id` - ゲームプロジェクト更新
- `DELETE /games/:id` - ゲームプロジェクト削除（論理削除）
- `GET /games/:id/scenes` - シーン一覧取得
- `POST /games/:id/scenes` - シーン作成・更新
- `GET /games/scenes/:sceneId/nodes` - ノード一覧取得
- `POST /games/scenes/:sceneId/nodes` - ノード作成・更新
- `DELETE /games/nodes/:nodeId` - ノード削除

**認証:**
- ほとんどのエンドポイントは `SupabaseAuthGuard` で保護
- `GET /games/:id` のみ `OptionalSupabaseAuthGuard`（公開ゲームの再生のため）

#### 3. フロントエンド (Nuxt4/Vue3)

**新規ページ:**
1. `/my/games` - ゲームプロジェクト一覧・作成
2. `/my/games/[id]/edit` - ゲームエディタ（3カラムレイアウト）
   - 左: シーン一覧
   - 中央: ノード一覧
   - 右: プロパティエディタ
3. `/games/[id]/play` - ゲームプレイヤー（認証不要）

**コンポーザブル:**
- `useGamesApi()` - ゲームAPIクライアント

#### 4. テスト雛形
- `apps/api/test/games.e2e-spec.ts` - APIのE2Eテスト雛形
- `apps/frontend/tests/gameRuntime.spec.ts` - フロントエンドのユニットテスト雛形

### 📋 機能仕様

#### ゲームプロジェクト
- タイトル、概要、カバー画像（Asset ID）
- 公開/非公開設定（isPublic）
- 論理削除対応

#### シーン
- ゲームの章や場面を表現
- 順序指定可能（order）
- 複数のノードを含む

#### ノード（DIALOG型）
- **台詞**: テキスト本文
- **話者**: キャラクターID + 感情ラベル
- **背景**: Asset IDで背景画像を指定
- **音楽**: BGM Asset ID
- **効果音**: SFX Asset ID
- **次のノード**: 直線的な遷移用（nextNodeId）
- **選択肢**: 分岐用（choices配列）

#### 選択肢
- 表示ラベル
- 遷移先ノードID（targetNodeId）

### 🎮 使用方法

#### 1. ゲームの作成
1. `/my/games` にアクセス
2. タイトルを入力して「作成」ボタンをクリック
3. 作成されたゲームの「編集」をクリック

#### 2. ゲームの編集
1. 左カラムで「シーン追加」
2. 中央カラムで「台詞追加」してノードを作成
3. 右カラムでノードのプロパティを編集
   - 台詞テキスト
   - 話者情報
   - 背景・音楽Asset ID
   - 次のノードID（直線的な進行）
   - 選択肢（分岐）
4. 「保存」ボタンで更新

#### 3. ゲームの再生
1. ゲーム一覧から「再生」または「プレビュー」をクリック
2. `/games/[id]/play` でゲームが再生される
3. 「スタート」ボタンで開始
4. 台詞を読み進める（「次へ」ボタン）
5. 選択肢がある場合は選択して分岐

### 🚧 今後の拡張（次期フェーズ）

#### 優先度: 高
- [ ] 変数/フラグシステム
- [ ] 条件分岐（選択肢の表示条件）
- [ ] キャラクター立ち絵の自動切り替え
- [ ] セーブ/ロード機能
- [ ] 既読管理

#### 優先度: 中
- [ ] アセットピッカー連携（エディタからアセット選択）
- [ ] ノードのドラッグ&ドロップ並べ替え
- [ ] オート再生/スキップ機能
- [ ] トランジション効果

#### 優先度: 低
- [ ] ビジュアルノードエディタ（フロー図）
- [ ] ゲームのエクスポート/インポート
- [ ] ゲームのバージョン管理
- [ ] 複数人での共同編集

### 🔧 技術スタック

- **Backend**: NestJS 10 + Prisma + PostgreSQL
- **Frontend**: Nuxt 4 + Vue 3 + Tailwind CSS
- **認証**: Supabase Auth (JWT)
- **ストレージ**: MinIO (S3互換)
- **検索**: MeilisSearch

### 📝 注意事項

1. **Asset ID**: 背景画像やBGMは既存のAssetシステムを使用します
2. **署名URL**: アセットの表示は署名付きGET URL経由で行います
3. **認証**: ゲーム編集は認証必須、公開ゲームの再生は認証不要です
4. **削除**: ゲームプロジェクトの削除は論理削除（deletedAt）です

### 🐛 既知の問題

- TypeScriptの型エラーが表示される場合がありますが、これはPrismaクライアント生成後にTypeScriptサーバーの再起動が必要なためです
- 開発時は `SUPABASE_JWT_SECRET` が未設定でも動作します（開発モード）

### 🎯 次のステップ

1. APIサーバーを起動: `pnpm -C apps/api start:dev`
2. フロントエンドを起動: `pnpm -C apps/frontend dev`
3. `/my/games` にアクセスしてゲームを作成
4. エディタでシーン・ノードを追加
5. プレイヤーで再生確認

---

実装日: 2025年11月3日
実装者: GitHub Copilot
