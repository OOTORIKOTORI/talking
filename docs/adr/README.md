# ADR (Architecture Decision Records)

設計判断を記録し、後から「なぜこうしたか」を振り返るためのドキュメントです。

---

## ADR とは

- **A**rchitecture **D**ecision **R**ecords の略
- 重要な技術的決定を短い文書で記録
- 日付と連番で管理 (例: `2025-10-26-0001-signed-url.md`)

---

## ADR 運用ポリシー

### 記録すべき決定

- アーキテクチャの選択 (REST vs GraphQL, Monorepo vs 分離, etc.)
- セキュリティ方針 (認証方式, CORS, etc.)
- データモデルの設計 (正規化, スキーマ変更)
- ライブラリ・フレームワークの採用 (Nuxt, Prisma, etc.)
- 命名規則・コーディング規約

### 記録しない決定

- 軽微なバグ修正
- UI の微調整
- コメント追加

---

## ADR のフォーマット

```markdown
# ADR-XXXX: タイトル

## 日付
YYYY-MM-DD

## 状況 (Context)
(どういう課題・背景があったか)

## 決定 (Decision)
(何を決めたか)

## 理由 (Rationale)
(なぜそう決めたか)

## 影響 (Consequences)
(この決定による影響・トレードオフ)
```

---

## 既存の ADR 一覧

### ADR-0001: 署名付き GET で表示 (バケット公開しない)

**日付**: 2025-10-26

**状況**:
MinIO のバケットを公開すると、誰でもアクセス可能になってしまう。

**決定**:
バケットは非公開とし、GET/PUT は署名付き URL でアクセスする。

**理由**:
- セキュリティを確保
- アクセス制御を API で一元管理
- S3 のベストプラクティスに準拠

**影響**:
- 毎回署名付き URL を生成する必要がある (パフォーマンスへの影響は軽微)
- CORS 設定が必須

---

### ADR-0002: BullMQ のキュー名はハイフン区切り

**日付**: 2025-10-26

**状況**:
BullMQ のキュー名にコロン `:` を使うと、Redis のキー名と衝突する可能性がある。

**決定**:
キュー名は `search-index` のようにハイフン区切りを採用。

**理由**:
- Redis のキー名規約との衝突を回避
- BullMQ 公式ドキュメントでもハイフンが推奨

**影響**:
- 既存のキュー名を変更する場合、Redis のキーを削除する必要がある
- コード内のキュー名を統一

---

## ADR の作成手順

### 1. ファイル名を決める

```
docs/adr/YYYY-MM-DD-XXXX-short-title.md
```

例: `docs/adr/2025-10-26-0003-tag-storage.md`

### 2. テンプレートをコピー

```markdown
# ADR-0003: タグは配列型で保存

## 日付
2025-10-26

## 状況
アセットに複数のタグを付与したい。正規化するか、配列型で保存するか。

## 決定
Prisma の `String[]` で配列型保存を採用。

## 理由
- MVP では複雑な検索は不要
- Meilisearch で全文検索可能
- 実装がシンプル

## 影響
- タグの統計情報を取る場合は SQL が複雑になる
- 将来的に正規化が必要になる可能性
```

### 3. README に追加

`docs/adr/README.md` の「既存の ADR 一覧」に追記してください。

---

## ベストプラクティス

- **短く書く**: 1ページ以内
- **理由を明記**: 「なぜこの選択肢を選んだか」が最重要
- **トレードオフを記載**: メリット・デメリット両方を書く
- **後で読み返す**: 半年後の自分が理解できるように

---

## 関連ドキュメント

- [ハンドオフ手順](../handoff.md): 複数チャット向け引き継ぎ
- [ワークフロー](../workflow.md): ブランチ・コミット規約
